<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Numerics · PinCFlow.jl</title><meta name="title" content="Numerics · PinCFlow.jl"/><meta property="og:title" content="Numerics · PinCFlow.jl"/><meta property="twitter:title" content="Numerics · PinCFlow.jl"/><meta name="description" content="Documentation for PinCFlow.jl."/><meta property="og:description" content="Documentation for PinCFlow.jl."/><meta property="twitter:description" content="Documentation for PinCFlow.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">PinCFlow.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../../examples/mountain_wave_simulation/">Mountain-wave simulation</a></li><li><a class="tocitem" href="../../examples/wkb_mountain_wave_simulation/">WKB mountain-wave simulation</a></li></ul></li><li><span class="tocitem">Theory</span><ul><li><a class="tocitem" href="../physics/">Physics</a></li><li class="is-active"><a class="tocitem" href>Numerics</a><ul class="internal"><li><a class="tocitem" href="#Temporal-discretization"><span>Temporal discretization</span></a></li><li><a class="tocitem" href="#Spatial-discretization"><span>Spatial discretization</span></a></li></ul></li></ul></li><li><span class="tocitem">Reference</span><ul><li><a class="tocitem" href="../../reference/pincflow/">PinCFlow</a></li><li><a class="tocitem" href="../../reference/types/">Types</a></li><li><a class="tocitem" href="../../reference/mpi_operations/">MPIOperations</a></li><li><a class="tocitem" href="../../reference/boundaries/">Boundaries</a></li><li><a class="tocitem" href="../../reference/flux_calculator/">FluxCalculator</a></li><li><a class="tocitem" href="../../reference/poisson_solver/">PoissonSolver</a></li><li><a class="tocitem" href="../../reference/update/">Update</a></li><li><a class="tocitem" href="../../reference/msgwam/">MSGWaM</a></li><li><a class="tocitem" href="../../reference/integration/">Integration</a></li><li><a class="tocitem" href="../../reference/output/">Output</a></li></ul></li><li><a class="tocitem" href="../../developer_guide/">Developer guide</a></li><li><a class="tocitem" href="../../changelog/">Changelog</a></li><li><a class="tocitem" href="../../authors/">Authors</a></li><li><a class="tocitem" href="../../contributing/">Contributing</a></li><li><a class="tocitem" href="../../code_of_conduct/">Code of Conduct</a></li><li><a class="tocitem" href="../../license/">License</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Theory</a></li><li class="is-active"><a href>Numerics</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Numerics</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/Atmospheric-Dynamics-GUF/PinCFlow.jl.git" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Numerics"><a class="docs-heading-anchor" href="#Numerics">Numerics</a><a id="Numerics-1"></a><a class="docs-heading-anchor-permalink" href="#Numerics" title="Permalink"></a></h1><h2 id="Temporal-discretization"><a class="docs-heading-anchor" href="#Temporal-discretization">Temporal discretization</a><a id="Temporal-discretization-1"></a><a class="docs-heading-anchor-permalink" href="#Temporal-discretization" title="Permalink"></a></h2><h3 id="Pseudo-incompressible-mode"><a class="docs-heading-anchor" href="#Pseudo-incompressible-mode">Pseudo-incompressible mode</a><a id="Pseudo-incompressible-mode-1"></a><a class="docs-heading-anchor-permalink" href="#Pseudo-incompressible-mode" title="Permalink"></a></h3><p>The pseudo-incompressible equations are integrated with the semi-implicit time scheme</p><p class="math-container">\[\begin{align*}
    1. &amp;&amp; \rho&#39;^n &amp; = \rho^n - \overline{\rho},\\
    2. &amp;&amp; \left(\rho^\#, \rho&#39;^\#, \widehat{\boldsymbol{u}}^\#\right) &amp; = \mathrm{L}_{\Delta t / 2} \left(\rho^n, \rho&#39;^n, \widehat{\boldsymbol{u}}^n, \widehat{\boldsymbol{u}}^n, \alpha_\mathrm{R}^{n + 1}\right)\\
    3. &amp;&amp; \left(\rho&#39;^{n + 1 / 2}, \widehat{\boldsymbol{u}}^{n + 1 / 2}, \pi&#39;^{n + 1 / 2}\right) &amp; = \mathrm{RI}_{\Delta t / 2} \left(\rho^\#, \rho&#39;^\#, \widehat{\boldsymbol{u}}^\#, \pi&#39;^n, \beta_\mathrm{R}^{n + 1}\right)\\
    4. &amp;&amp; \left(\rho&#39;^*, \widehat{\boldsymbol{u}}^*\right) &amp; = \mathrm{RE}_{\Delta t / 2} \left(\rho^n, \rho&#39;^n, \widehat{\boldsymbol{u}}^n, \pi&#39;^{n + 1 / 2}\right)\\
    5. &amp;&amp; \left(\rho^{**}, \rho&#39;^{**}, \widehat{\boldsymbol{u}}^{**}\right) &amp; = \mathrm{L}_{\Delta t} \left(\rho^n, \rho&#39;^*, \widehat{\boldsymbol{u}}^*, \widehat{\boldsymbol{u}}^{n + 1 / 2}, \alpha_\mathrm{R}^{n + 1}\right)\\
    6. &amp;&amp; \left(\rho&#39;^{n + 1}, \widehat{\boldsymbol{u}}^{n + 1}, \pi&#39;^{n + 1}\right) &amp; = \mathrm{RI}_{\Delta t / 2} \left(\rho^{**}, \rho&#39;^{**}, \widehat{\boldsymbol{u}}^{**}, \pi&#39;^{n + 1 / 2}, 2 \beta_\mathrm{R}^{n + 1}\right),
\end{align*}\]</p><p>where the operators <span>$\mathrm{L}$</span>, <span>$\mathrm{RI}$</span> and <span>$\mathrm{RE}$</span> perform an explicit integration of the left-hand sides, an implicit integration of the right-hand sides and an explicit integration of the right-hand sides, each over the time step indicated in its subscript, respectively. The superscripts represent various time levels between those before (<span>$n$</span>) and after (<span>$n + 1$</span>) the current time step <span>$\Delta t = t^{n + 1} - t^n$</span>. In <span>$\mathrm{L}$</span>, the fourth argument is the velocity by which the prognostic variables are transported (<a href="https://doi.org/10.1175/mwr-d-19-0073.1">Benacchio &amp; Klein, 2019</a>; <a href="https://doi.org/10.1175/MWR-D-21-0126.1">Schmid et al., 2021</a>). A complete description of the exact implementation of these steps follows here.</p><ol><li><p>The density fluctuations are synchronized with the full density, i.e.</p><p class="math-container">\[\rho&#39;^n = \rho^n - \overline{\rho}.\]</p></li><li><p>The left-hand sides are integrated over <span>$\Delta t / 2$</span> with a low-storage RK3 scheme (<a href="https://doi.org/10.1016/0021-9991(80)90033-9">Williamson, 1980</a>). Fractional implicit Euler steps are used to integrate the Rayleigh-damping terms of the LHS sponge. At every RK3 stage <span>$m$</span>, the following updates are performed.</p><ol><li><p>Density update:</p><p class="math-container">\[\begin{align*}
    q^{\rho, m + 1} &amp; = - \frac{\Delta t}{2 J} \left(\frac{\partial J \rho^m u^n}{\partial \widehat{x}} + \frac{\partial J \rho^m v^n}{\partial \widehat{y}} + \frac{\partial J \rho^m \widehat{w}^n}{\partial \widehat{z}}\right) + \left(\alpha_\mathrm{RK} q^\rho\right)^m,\\
    \rho^{m + 1} &amp; = \rho^m + \beta_\mathrm{RK}^m q^{\rho, m + 1},\\
    \rho^{m + 1} &amp; \rightarrow \left(1 + \alpha_\mathrm{R}^{n + 1} f_\mathrm{RK}^m \frac{\Delta t}{2}\right)^{- 1} \left(\rho^{m + 1} + \alpha_\mathrm{R}^{n + 1} f_\mathrm{RK}^m \frac{\Delta t}{2} \overline{\rho}\right)
\end{align*}\]</p></li><li><p>Density-fluctuations update:</p><p class="math-container">\[\begin{align*}
    q^{\rho&#39;, m + 1} &amp; = - \frac{\Delta t}{2 J} \left(\frac{\partial J \rho&#39;^m u^n}{\partial \widehat{x}} + \frac{\partial J \rho&#39;^m v^n}{\partial \widehat{y}} + \frac{\partial J \rho&#39;^m \widehat{w}^n}{\partial \widehat{z}}\right) + \left(\alpha_\mathrm{RK} q^{\rho&#39;}\right)^m,\\
    \rho&#39;^{m + 1} &amp; = \rho&#39;^m + \beta_\mathrm{RK}^m q^{\rho&#39;, m + 1},\\
    \rho&#39;^{m + 1} &amp; \rightarrow \left(1 + \alpha_\mathrm{R}^{n + 1} f_\mathrm{RK}^m \frac{\Delta t}{2}\right)^{- 1} \rho&#39;^{m + 1}
\end{align*}\]</p></li><li><p>Wind update:</p><p class="math-container">\[\begin{align*}
    q^{\rho u, m + 1} &amp; = \frac{\Delta t}{2} \left[- \mathcal{A}^{\rho u, m, n} + \mathcal{V}^{\rho u, m} + \mathcal{X}^{\rho u, m} + f \left(\rho v\right)^m\right] + \left(\alpha_\mathrm{RK} q^{\rho u}\right)^m,\\
    u^{m + 1} &amp; = \left(\rho^{- 1}\right)^{m + 1} \left[\left(\rho u\right)^m + \beta_\mathrm{RK}^m q^{\rho u, m + 1}\right],\\
    q^{\rho v, m + 1} &amp; = \frac{\Delta t}{2} \left[- \mathcal{A}^{\rho v, m, n} + \mathcal{V}^{\rho v, m} + \mathcal{X}^{\rho v, m} - f \left(\rho u\right)^m\right] + \left(\alpha_\mathrm{RK} q^{\rho v}\right)^m,\\
    v^{m + 1} &amp; = \left(\rho^{- 1}\right)^{m + 1} \left[\left(\rho v\right)^m + \beta_\mathrm{RK}^m q^{\rho v, m + 1}\right],\\
    q^{\rho \widehat{w}, m + 1} &amp; = \frac{\Delta t}{2} \left[- \mathcal{A}^{\rho \widehat{w}, m, n} + \mathcal{V}^{\rho \widehat{w}, m} + \mathcal{X}^{\rho \widehat{w}, m} + G^{13} f \left(\rho v\right)^m - G^{23} f \left(\rho u\right)^m\right] + \left(\alpha_\mathrm{RK} q^{\rho \widehat{w}}\right)^m\\
    \widehat{w}^{m + 1} &amp; = \left(\rho^{- 1}\right)^{m + 1} \left[\left(\rho \widehat{w}\right)^m + \beta_\mathrm{RK}^m q^{\rho \widehat{w}, m + 1}\right],\\
    \widehat{\boldsymbol{u}}^{m + 1} &amp; \rightarrow \left(1 + \alpha_\mathrm{R}^{n + 1} f_\mathrm{RK}^m \frac{\Delta t}{2}\right)^{- 1} \left(\widehat{\boldsymbol{u}}^{m + 1} + \alpha_\mathrm{R}^{n + 1} f_\mathrm{RK}^m \frac{\Delta t}{2} \widehat{\boldsymbol{u}}_\mathrm{R}^{m + 1}\right)
\end{align*}\]</p></li></ol><p>Therein, <span>$\alpha_\mathrm{RK}^m$</span> and <span>$\beta_\mathrm{RK}^m$</span> are the RK3 coefficients, with <span>$\alpha_\mathrm{RK}^m = 0$</span> at the first stage, and <span>$f_\mathrm{RK}^m$</span> are the ratios between the sizes of the full time step and the RK3 substeps. The advective momentum-flux divergences are given by</p><p class="math-container">\[\begin{align*}
    \mathcal{A}^{\rho u, m, n} &amp; = \frac{1}{J} \left[\frac{\partial J \left(\rho u\right)^m u^n}{\partial \widehat{x}} + \frac{\partial J \left(\rho u\right)^m v^n}{\partial \widehat{y}} + \frac{\partial J \left(\rho u\right)^m \widehat{w}^n}{\partial \widehat{z}}\right],\\
    \mathcal{A}^{\rho v, m, n} &amp; = \frac{1}{J} \left[\frac{\partial J \left(\rho v\right)^m u^n}{\partial \widehat{x}} + \frac{\partial J \left(\rho v\right)^m v^n}{\partial \widehat{y}} + \frac{\partial J \left(\rho v\right)^m \widehat{w}^n}{\partial \widehat{z}}\right],\\
    \mathcal{A}^{\rho \widehat{w}, m, n} &amp; = G^{13} \mathcal{A}^{\rho u, m, n} + G^{23} \mathcal{A}^{\rho v, m, n} + \frac{1}{J^2} \left[\frac{\partial J \left(\rho w\right)^m u^n}{\partial \widehat{x}} + \frac{\partial J \left(\rho w\right)^m v^n}{\partial \widehat{y}} + \frac{\partial J \left(\rho w\right)^m \widehat{w}^n}{\partial \widehat{z}}\right].
\end{align*}\]</p></li><li><p>The right-hand sides are integrated over <span>$\Delta t / 2$</span> with an implicit Euler step. The divergence constraint is then enforced by solving a Poisson equation for Exner-pressure differences <span>$\Delta \pi&#39;$</span>, which are used to correct the wind, the density fluctuations and the Exner-pressure itself. The details of these substeps are as follows.</p><ol><li><p>Predictor step:</p><p class="math-container">\[\begin{align*}
    u^{n + 1 / 2} &amp; = \left(1 + \beta_\mathrm{R}^{n + 1} \frac{\Delta t}{2}\right)^{- 1} \left[u^\# + \frac{\Delta t}{2} \left(- c_p \frac{P}{\rho^\#} \mathcal{P}^{\rho u, n} + \frac{F^{\rho u, n + 1}}{\rho^\#}\right)\right],\\
    v^{n + 1 / 2} &amp; = \left(1 + \beta_\mathrm{R}^{n + 1} \frac{\Delta t}{2}\right)^{- 1} \left[v^\# + \frac{\Delta t}{2} \left(- c_p \frac{P}{\rho^\#} \mathcal{P}^{\rho v, n} + \frac{F^{\rho v, n + 1}}{\rho^\#}\right)\right],\\
    \widehat{w}^{n + 1 / 2} &amp; = \left[1 + \beta_\mathrm{R}^{n + 1} \frac{\Delta t}{2} + \frac{\overline{\rho}}{\rho^\#} \frac{\left(N \Delta t\right)^2}{4}\right]^{- 1}\\
    &amp; \quad \times \left[\widehat{w}^\# + \frac{\Delta t}{2} \left(- c_p \frac{P}{\rho^\#} \mathcal{P}^{\rho \widehat{w}, n} + \frac{b&#39;^\#}{J} + \frac{F^{\rho \widehat{w}, n + 1}}{\rho^\#}\right) \vphantom{\frac{\overline{\rho}}{\rho^\#} \frac{\left(N \Delta t\right)^2}{4}}\right.\\
    &amp; \qquad \quad + \left.\frac{\overline{\rho}}{\rho^\#} \frac{\left(N \Delta t\right)^2}{4} \left(G^{1 3} u^{n + 1 / 2} + G^{2 3} v^{n + 1 / 2}\right)\right],\\
    \rho&#39;^{n + 1 / 2} &amp; = - \frac{\rho^\#}{g} \left[1 + \beta_\mathrm{R}^{n + 1} \frac{\Delta t}{2} + \frac{\overline{\rho}}{\rho^\#} \frac{\left(N \Delta t\right)^2}{4}\right]^{- 1}\\
    &amp; \quad \times \left\{- \frac{\overline{\rho}}{\rho^\#} N^2 \frac{\Delta t}{2} J \left[\widehat{w}^\# + \frac{\Delta t}{2} \left(- c_p \frac{P}{\rho^\#} \mathcal{P}^{\rho \widehat{w}, n} + \frac{F^{\rho \widehat{w}, n + 1}}{\rho^\#}\right)\right]\right.\\
    &amp; \qquad \quad + \left(1 + \beta_\mathrm{R}^{n + 1} \frac{\Delta t}{2}\right) b&#39;^\# + \frac{\overline{\rho}}{\rho^\#} N^2 \frac{\Delta t}{2} J \left(1 + \beta_\mathrm{R}^{n + 1} \frac{\Delta t}{2}\right)\\
    &amp; \qquad \quad \times \left.\left(G^{1 3} u^{n + 1 / 2} + G^{2 3} v^{n + 1 / 2}\right) \vphantom{\frac{\overline{\rho}}{\rho^\#} N^2 \frac{\Delta t}{2}}\right\}
\end{align*}\]</p></li><li><p>Poisson equation:</p><p class="math-container">\[\begin{align*}
    &amp; \frac{1}{J} \left(\frac{\partial J P u^{n + 1 / 2}}{\partial \widehat{x}} + \frac{\partial J P v^{n + 1 / 2}}{\partial \widehat{y}} + \frac{\partial J P \widehat{w}^{n + 1 / 2}}{\partial \widehat{z}}\right)\\
    &amp; \quad = \frac{1}{J} \left\{\frac{\partial J P \mathcal{C}^{\rho u, \#, n + 1}}{\partial \widehat{x}} + \frac{\partial J P \mathcal{C}^{\rho v, \#, n + 1}}{\partial \widehat{y}} \vphantom{\left(\frac{\overline{\rho}}{\rho^\#} \frac{\left(N \Delta t\right)^2}{4}\right)^{- 1}}\right.\\
    &amp; \qquad \qquad + \frac{\partial}{\partial \widehat{z}} \left[\left(1 + \beta_\mathrm{R}^{n + 1} \frac{\Delta t}{2} + \frac{\overline{\rho}}{\rho^\#} \frac{\left(N \Delta t\right)^2}{4}\right)^{- 1}\right.\\
    &amp; \qquad \qquad \qquad \quad \times \left(\frac{\Delta t}{2} c_p \frac{J P^2}{\rho^\#} \mathcal{D}^{\rho \widehat{w}} + J P \frac{\overline{\rho}}{\rho^\#} \frac{\left(N \Delta t\right)^2}{4}\right.\\
    &amp; \qquad \qquad \qquad \qquad \quad \times \left.\left.\left.\left(G^{13} \mathcal{C}^{\rho u, \#, n + 1} + G^{23} \mathcal{C}^{\rho v, \#, n + 1}\right) \vphantom{\frac{\overline{\rho}}{\rho^\#} \frac{\left(N \Delta t\right)^2}{4}}\right) \vphantom{\left(\frac{\overline{\rho}}{\rho^\#} \frac{\left(N \Delta t\right)^2}{4}\right)^{- 1}}\right]\right\}
\end{align*}\]</p></li><li><p>Corrector step:</p><p class="math-container">\[\begin{align*}
    u^{n + 1 / 2} &amp; \rightarrow u^{n + 1 / 2} - \mathcal{C}^{\rho u, \#, n + 1},\\
    v^{n + 1 / 2} &amp; \rightarrow v^{n + 1 / 2} - \mathcal{C}^{\rho v, \#, n + 1},\\
    \widehat{w}^{n + 1 / 2} &amp; \rightarrow \widehat{w}^{n + 1 / 2} - \left[1 + \beta_\mathrm{R}^{n + 1} \frac{\Delta t}{2} + \frac{\overline{\rho}}{\rho^\#} \frac{\left(N \Delta t\right)^2}{4}\right]^{- 1}\\
    &amp; \quad \times \left[\frac{\Delta t}{2} c_p \frac{P}{\rho^\#} \mathcal{D}^{\rho \widehat{w}} + \frac{\overline{\rho}}{\rho^\#} \frac{\left(N \Delta t\right)^2}{4} \left(G^{1 3} \mathcal{C}^{\rho u, \#, n + 1} + G^{23} \mathcal{C}^{\rho v, \#, n + 1}\right)\right],\\
    \rho&#39;^{n + 1 / 2} &amp; \rightarrow \rho&#39;^{n + 1 / 2} + \frac{\rho^\#}{g} \left[1 + \beta_\mathrm{R}^{n + 1} \frac{\Delta t}{2} + \frac{\overline{\rho}}{\rho^\#} \frac{\left(N \Delta t\right)^2}{4}\right]^{- 1}\\
    &amp; \quad \times \left[- \frac{\overline{\rho}}{\rho^\#} \frac{\left(N \Delta t\right)^2}{4} J c_p \frac{P}{\rho^\#} \mathcal{D}^{\rho \widehat{w}} + \frac{\overline{\rho}}{\rho^\#} N^2 \frac{\Delta t}{2} J \left(1 + \beta_\mathrm{R}^{n + 1} \frac{\Delta t}{2}\right)\right.\\
    &amp; \qquad \quad \times \left.\left(G^{1 3} \mathcal{C}^{\rho u, \#, n + 1} + G^{2 3} \mathcal{C}^{\rho v, \#, n + 1}\right) \vphantom{\frac{\overline{\rho}}{\rho^\#} \frac{\left(N \Delta t\right)^2}{4}}\right],\\
    \pi&#39;^{n + 1 / 2} &amp; = \pi&#39;^n + \Delta \pi&#39;
\end{align*}\]</p></li></ol><p>Therein, <span>$b&#39; = - g \rho&#39; / \rho$</span>, the pressure-difference gradient is given by</p><p class="math-container">\[\begin{align*}
    \mathcal{D}^{\rho u} &amp; = \left(\frac{\partial \Delta \pi&#39;}{\partial \widehat{x}} + G^{13} \frac{\partial \Delta \pi&#39;}{\partial \widehat{z}}\right),\\
    \mathcal{D}^{\rho v} &amp; = \left(\frac{\partial \Delta \pi&#39;}{\partial \widehat{y}} + G^{23} \frac{\partial \Delta \pi&#39;}{\partial \widehat{z}}\right),\\
    \mathcal{D}^{\rho \widehat{w}} &amp; = \left(G^{13} \frac{\partial \Delta \pi&#39;}{\partial \widehat{x}} + G^{23} \frac{\partial \Delta \pi&#39;}{\partial \widehat{y}} + G^{33} \frac{\partial \Delta \pi&#39;}{\partial \widehat{z}}\right)
\end{align*}\]</p><p>and the horizontal-wind correction terms are</p><p class="math-container">\[\begin{align*}
    \mathcal{C}^{\rho u, \#, n + 1} &amp; = \left(1 + \beta_\mathrm{R}^{n + 1} \frac{\Delta t}{2}\right)^{- 1} \frac{\Delta t}{2} c_p \frac{P}{\rho^\#} \mathcal{D}^{\rho u},\\
    \mathcal{C}^{\rho v, \#, n + 1} &amp; = \left(1 + \beta_\mathrm{R}^{n + 1} \frac{\Delta t}{2}\right)^{- 1} \frac{\Delta t}{2} c_p \frac{P}{\rho^\#} \mathcal{D}^{\rho v}.
\end{align*}\]</p></li><li><p>The right-hand sides (without the Rayleigh-damping terms) are integrated over <span>$\Delta t / 2$</span> with an explicit Euler step. Therein, the Exner-pressure fluctuations <span>$\pi&#39;^{n + 1 / 2}$</span> are used to compute the pressure gradient. The exact updates are</p><p class="math-container">\[\begin{align*}
    u^* &amp; = u^n + \frac{\Delta t}{2} \left(- c_p \frac{P}{\rho^n} \mathcal{P}^{\rho u, n + 1 / 2} + \frac{F^{\rho u, n + 1}}{\rho^n}\right),\\
    v^* &amp; = v^n + \frac{\Delta t}{2} \left(- c_p \frac{P}{\rho^n} \mathcal{P}^{\rho v, n + 1 / 2} + \frac{F^{\rho v, n + 1}}{\rho^n}\right),\\
    \widehat{w}^* &amp; = \widehat{w}^n + \frac{\Delta t}{2} \left(- c_p \frac{P}{\rho^n} \mathcal{P}^{\rho \widehat{w}, n + 1 / 2} + \frac{b&#39;^n}{J} + \frac{F^{\rho \widehat{w}, n + 1}}{\rho^n}\right),\\
    \rho&#39;^* &amp; = - \frac{\rho^n}{g} \left[b&#39;^n - \frac{\Delta t}{2} \overline{\rho} N^2 \left(\frac{w}{\rho}\right)^n\right].
\end{align*}\]</p></li><li><p>The left-hand sides are integrated over <span>$\Delta t$</span> with the low-storage RK3 scheme. Fractional implicit Euler steps are once again used to integrate the Rayleigh-damping terms of the LHS sponge. This step is equivalent to the first one, except for the differences indicated in the compact description above.</p></li><li><p>The right-hand sides are integrated over <span>$\Delta t / 2$</span> with an implicit Euler step, followed by the Poisson equation being solved and a correction step being performed. The Rayleigh-damping terms are doubled, since they were left out in the explicit Euler step. This step is equivalent to the second one, except for the differences indicated in the compact description above.</p></li></ol><h3 id="Boussinesq-mode"><a class="docs-heading-anchor" href="#Boussinesq-mode">Boussinesq mode</a><a id="Boussinesq-mode-1"></a><a class="docs-heading-anchor-permalink" href="#Boussinesq-mode" title="Permalink"></a></h3><p>In Boussinesq mode, the time scheme remains mostly unchanged. As has been mentioned in the description of the physics, the continuity equation is removed, as are the density fluctuations everywhere except in the auxiliary equation and the buoyancy term of the transformed-vertical-momentum equation. Furthermore, <span>$\overline{\rho}$</span>, <span>$\overline{\theta}$</span>, <span>$P$</span> and <span>$N^2$</span> are replaced with <span>$\rho_0$</span>, <span>$\theta_0$</span>, <span>$P_0$</span> and <span>$N_0^2$</span>, respectively.</p><h3 id="Compressible-mode"><a class="docs-heading-anchor" href="#Compressible-mode">Compressible mode</a><a id="Compressible-mode-1"></a><a class="docs-heading-anchor-permalink" href="#Compressible-mode" title="Permalink"></a></h3><p>In compressible mode, the time scheme is changed in several ways, due to the mass-weighted potential temperature having a spatiotemporal dependence and being directly coupled to the Exner-pressure. It may be summarized by</p><p class="math-container">\[\begin{align*}
    1. &amp;&amp; \rho&#39;^n &amp; = \rho^n - \frac{P^n}{\overline{\theta}},\\
    2. &amp;&amp; \left(\rho^\#, \rho&#39;^\#, P^\#, \widehat{\boldsymbol{u}}^\#, \pi&#39;^\#\right) &amp; = \mathrm{L}_{\Delta t / 2} \left(\rho^n, \rho&#39;^n, P^n, \widehat{\boldsymbol{u}}^n, \pi&#39;^n, P^n, \widehat{\boldsymbol{u}}^n, \alpha_\mathrm{R}^{n + 1}\right)\\
    3. &amp;&amp; \left(\rho&#39;^{n + 1 / 2}, \widehat{\boldsymbol{u}}^{n + 1 / 2}, \pi&#39;^{n + 1 / 2}\right) &amp; = \mathrm{RI}_{\Delta t / 2} \left(\rho^\#, \rho&#39;^\#, P^\#, \widehat{\boldsymbol{u}}^\#, \pi&#39;^\#, \beta_\mathrm{R}^{n + 1}\right)\\
    4. &amp;&amp; \left(\rho&#39;^*, \widehat{\boldsymbol{u}}^*, \pi&#39;^*\right) &amp; = \mathrm{RE}_{\Delta t / 2} \left(\rho^n, \rho&#39;^n, P^n, \widehat{\boldsymbol{u}}^n, \pi&#39;^n\right)\\
    5. &amp;&amp; \left(\rho^{**}, \rho&#39;^{**}, P^{**}, \widehat{\boldsymbol{u}}^{**}, \pi&#39;^{**}\right) &amp; = \mathrm{L}_{\Delta t} \left(\rho^n, \rho&#39;^*, P^n, \widehat{\boldsymbol{u}}^*, \pi&#39;^{n + 1 / 2}, P^\#, \widehat{\boldsymbol{u}}^{n + 1 / 2}, \alpha_\mathrm{R}^{n + 1}\right)\\
    6. &amp;&amp; \left(\rho&#39;^{n + 1}, \widehat{\boldsymbol{u}}^{n + 1}, \pi&#39;^{n + 1}\right) &amp; = \mathrm{RI}_{\Delta t / 2} \left(\rho^{**}, \rho&#39;^{**}, P^{**}, \widehat{\boldsymbol{u}}^{**}, \pi&#39;^{**}, 2 \beta_\mathrm{R}^{n + 1}\right)
\end{align*}\]</p><p>(see <a href="https://doi.org/10.1175/mwr-d-19-0073.1">Benacchio &amp; Klein, 2019</a>; <a href="https://doi.org/10.1175/MWR-D-21-0175.1">Chew et al., 2022</a>). Another detailed description follows here.</p><ol><li><p>The density fluctuations are synchronized with the full density, i.e.</p><p class="math-container">\[\rho&#39;^n = \rho^n - \frac{P^n}{\overline{\theta}}.\]</p></li><li><p>The left-hand sides are integrated over <span>$\Delta t / 2$</span> with the low-storage RK3 scheme. Fractional implicit Euler steps are used to integrate the Rayleigh-damping terms of the LHS sponge. The updates at every RK3 stage are as follows.</p><ol><li><p>Density update:</p><p class="math-container">\[\begin{align*}
    q^{\rho, m + 1} &amp; = - \frac{\Delta t}{2 J} \left(\frac{\partial J \rho^m u^n}{\partial \widehat{x}} + \frac{\partial J \rho^m v^n}{\partial \widehat{y}} + \frac{\partial J \rho^m \widehat{w}^n}{\partial \widehat{z}}\right) + \left(\alpha_\mathrm{RK} q^\rho\right)^m,\\
    \rho^{m + 1} &amp; = \rho^m + \beta_\mathrm{RK}^m q^{\rho, m + 1},\\
    \rho^{m + 1} &amp; \rightarrow \left(1 + \alpha_\mathrm{R}^{n + 1} f_\mathrm{RK}^m \frac{\Delta t}{2}\right)^{- 1} \left(\rho^{m + 1} + \alpha_\mathrm{R}^{n + 1} f_\mathrm{RK}^m \frac{\Delta t}{2} \overline{\rho}\right)
\end{align*}\]</p></li><li><p>Density-fluctuations update:</p><p class="math-container">\[\begin{align*}
    q^{\rho&#39;, m + 1} &amp; = - \frac{\Delta t}{2} \left[\frac{1}{J} \left(\frac{\partial J \rho&#39;^m u^n}{\partial \widehat{x}} + \frac{\partial J \rho&#39;^m v^n}{\partial \widehat{y}} + \frac{\partial J \rho&#39;^m \widehat{w}^n}{\partial \widehat{z}}\right) + \frac{F^{P, n + 1}}{\overline{\theta}}\right] + \left(\alpha_\mathrm{RK} q^{\rho&#39;}\right)^m,\\
    \rho&#39;^{m + 1} &amp; = \rho&#39;^m + \beta_\mathrm{RK}^m q^{\rho&#39;, m + 1},\\
    \rho&#39;^{m + 1} &amp; \rightarrow \left(1 + \alpha_\mathrm{R}^{n + 1} f_\mathrm{RK}^m \frac{\Delta t}{2}\right)^{- 1} \left\{\rho&#39;^{m + 1} + \alpha_\mathrm{R}^{n + 1} f_\mathrm{RK}^m \frac{\Delta t}{2} \overline{\rho} \left[1 - \frac{\left(P / \rho\right)^{m + 1}}{\overline{\theta}}\right]\right\}
\end{align*}\]</p></li><li><p>Mass-weighted potential-temperature update:</p><p class="math-container">\[\begin{align*}
    q^{P, m + 1} &amp; = - \frac{\Delta t}{2} \left\{\frac{1}{J} \left[\frac{\partial J \left(P u\right)^n}{\partial \widehat{x}} + \frac{\partial J \left(P v\right)^n}{\partial \widehat{y}} + \frac{\partial J \left(P \widehat{w}\right)^n}{\partial \widehat{z}}\right] - F^{P, n + 1}\right\}\\
    &amp; \quad + \left(\alpha_\mathrm{RK} q^P\right)^m,\\
    P^{m + 1} &amp; = P^m + \beta_\mathrm{RK}^m q^{P, m + 1},\\
    P^{m + 1} &amp; \rightarrow \left(1 + \alpha_\mathrm{R}^{n + 1} f_\mathrm{RK}^m \frac{\Delta t}{2}\right)^{- 1} P^{m + 1} \left(1 + \alpha_\mathrm{R}^{n + 1} f_\mathrm{RK}^m \frac{\Delta t}{2} \frac{\overline{\rho}}{\rho^{m + 1}}\right)
\end{align*}\]</p></li><li><p>Wind update:</p><p class="math-container">\[\begin{align*}
    q^{\rho u, m + 1} &amp; = \frac{\Delta t}{2} \left[- \mathcal{A}^{\rho u, m, n} + \mathcal{V}^{\rho u, m} + \mathcal{X}^{\rho u, m} + f \left(\rho v\right)^m\right] + \left(\alpha_\mathrm{RK} q^{\rho u}\right)^m,\\
    u^{m + 1} &amp; = \left(\rho^{- 1}\right)^{m + 1} \left[\left(\rho u\right)^m + \beta_\mathrm{RK}^m q^{\rho u, m + 1}\right],\\
    q^{\rho v, m + 1} &amp; = \frac{\Delta t}{2} \left[- \mathcal{A}^{\rho v, m, n} + \mathcal{V}^{\rho v, m} + \mathcal{X}^{\rho v, m} - f \left(\rho u\right)^m\right] + \left(\alpha_\mathrm{RK} q^{\rho v}\right)^m,\\
    v^{m + 1} &amp; = \left(\rho^{- 1}\right)^{m + 1} \left[\left(\rho v\right)^m + \beta_\mathrm{RK}^m q^{\rho v, m + 1}\right],\\
    q^{\rho \widehat{w}, m + 1} &amp; = \frac{\Delta t}{2} \left[- \mathcal{A}^{\rho \widehat{w}, m, n} + \mathcal{V}^{\rho \widehat{w}, m} + \mathcal{X}^{\rho \widehat{w}, m} + G^{13} f \left(\rho v\right)^m - G^{23} f \left(\rho u\right)^m\right] + \left(\alpha_\mathrm{RK} q^{\rho \widehat{w}}\right)^m,\\
    \widehat{w}^{m + 1} &amp; = \left(\rho^{- 1}\right)^{m + 1} \left[\left(\rho \widehat{w}\right)^m + \beta_\mathrm{RK}^m q^{\rho \widehat{w}, m + 1}\right],\\
    \widehat{\boldsymbol{u}}^{m + 1} &amp; \rightarrow \left(1 + \alpha_\mathrm{R}^{n + 1} f_\mathrm{RK}^m \frac{\Delta t}{2}\right)^{- 1} \left(\widehat{\boldsymbol{u}}^{m + 1} + \alpha_\mathrm{R}^{n + 1} f_\mathrm{RK}^m \frac{\Delta t}{2} \widehat{\boldsymbol{u}}_\mathrm{R}^{m + 1}\right)
\end{align*}\]</p></li></ol><p>After the last RK3 step, the Exner-pressure fluctuations are updated according to the Rayleigh damping applied to the mass-weighted potential temperature, i.e.</p><p class="math-container">\[\begin{align*}
    \pi&#39;^\# = \pi&#39;^n - \alpha_\mathrm{R} \frac{\Delta t}{2} \left(P \frac{\partial \pi&#39;}{\partial P}\right)^\# \left(1 - \frac{\overline{\rho}}{\rho^\#}\right),
\end{align*}\]</p><p>where <span>$\left(\partial P / \partial \pi&#39;\right)^\# = \left(\gamma - 1\right)^{- 1} \left(R / p_\mathrm{ref}\right)^{1 - \gamma} \left(P^{2 - \gamma}\right)^\#$</span>, with <span>$\gamma$</span> being the ratio between the specific heat capacities and constant pressure and volume, <span>$R$</span> being the specific gas constant and <span>$p_\mathrm{ref}$</span> being the reference (ground) pressure.</p></li><li><p>The right-hand sides are integrated over <span>$\Delta t / 2$</span> with an implicit Euler step. The divergence constraint is then enforced by solving a Poisson equation for Exner-pressure differences <span>$\Delta \pi&#39;$</span>, which are used to correct the wind, the density fluctuations and the Exner-pressure itself. In principle, this is the same as in pseudo-incompressible mode, however, instead of <span>$\widehat{\boldsymbol{u}}$</span>, the predictor step updates <span>$\widehat{\boldsymbol{U}} = J P \widehat{\boldsymbol{u}}$</span>. The details are as follows.</p><ol><li><p>Predictor step:</p><p class="math-container">\[\begin{align*}
    U^{n + 1 / 2} &amp; = \left(1 + \beta_\mathrm{R}^{n + 1} \frac{\Delta t}{2}\right)^{- 1} \left\{U^\# + \frac{\Delta t}{2} J P^\# \left[- c_p \left(\frac{P}{\rho}\right)^\# \mathcal{P}^{\rho u, n} + \frac{F^{\rho u, n + 1}}{\rho^\#}\right]\right\},\\
    V^{n + 1 / 2} &amp; = \left(1 + \beta_\mathrm{R}^{n + 1} \frac{\Delta t}{2}\right)^{- 1} \left\{V^\# + \frac{\Delta t}{2} J P^\# \left[- c_p \left(\frac{P}{\rho}\right)^\# \mathcal{P}^{\rho v, n} + \frac{F^{\rho v, n + 1}}{\rho^\#}\right]\right\},\\
    \widehat{W}^{n + 1 / 2} &amp; = \left[1 + \beta_\mathrm{R}^{n + 1} \frac{\Delta t}{2} + \frac{\left(P /  \rho\right)^\#}{\overline{\theta}} \frac{\left(N \Delta t\right)^2}{4}\right]^{- 1}\\
    &amp; \quad \times \left\{\widehat{W}^\# + \frac{\Delta t}{2} J P^\# \left[- c_p \left(\frac{P}{\rho}\right)^\# \mathcal{P}^{\rho \widehat{w}, n} + \frac{b&#39;^\#}{J} + \frac{F^{\rho \widehat{w}, n + 1}}{\rho^\#}\right]\right.\\
    &amp; \qquad \quad + \left.J P^\#\frac{\left(P /  \rho\right)^\#}{\overline{\theta}} \frac{\left(N \Delta t\right)^2}{4} \left[G^{1 3} \frac{U^{n + 1 / 2}}{J P^\#} + G^{2 3} \frac{V^{n + 1 / 2}}{J P^\#}\right]\right\},\\
    \rho&#39;^{n + 1 / 2} &amp; = - \frac{\rho^\#}{g} \left[1 + \beta_\mathrm{R}^{n + 1} \frac{\Delta t}{2} + \frac{\left(P /  \rho\right)^\#}{\overline{\theta}} \frac{\left(N \Delta t\right)^2}{4}\right]^{- 1}\\
    &amp; \quad \times \left\{- \frac{\left(P /  \rho\right)^\#}{\overline{\theta}} N^2 \frac{\Delta t}{2} J \left[\frac{\widehat{W}^\#}{J P^\#} + \frac{\Delta t}{2} \left(- c_p \left(\frac{P}{\rho}\right)^\# \mathcal{P}^{\rho \widehat{w}, n} + \frac{F^{\rho \widehat{w}, n + 1}}{\rho^\#}\right)\right]\right.\\
    &amp; \qquad \quad  + \left(1 + \beta_\mathrm{R}^{n + 1} \frac{\Delta t}{2}\right) b&#39;^\# + \frac{\left(P /  \rho\right)^\#}{\overline{\theta}} N^2 \frac{\Delta t}{2} J \left(1 + \beta_\mathrm{R}^{n + 1} \frac{\Delta t}{2}\right)\\
    &amp; \qquad \quad \times \left.\left(G^{1 3} \frac{U^{n + 1 / 2}}{J P^\#} + G^{2 3} \frac{V^{n + 1 / 2}}{J P^\#}\right) \vphantom{\left[\left(\left(\frac{P}{\rho}\right)^\#\right)\right]}\right\}
\end{align*}\]</p></li><li><p>Poisson equation:</p><p class="math-container">\[\begin{align*}
    &amp; \frac{1}{J} \left[\frac{\partial U^{n + 1 / 2}}{\partial \widehat{x}} + \frac{\partial V^{n + 1 / 2}}{\partial \widehat{y}} + \frac{\partial \widehat{W}^{n + 1 / 2}}{\partial \widehat{z}}\right] - F^{P, n + 1}\\
    &amp; \quad = - \left(\frac{\partial P}{\partial \pi&#39;}\right)^\# \frac{2 \Delta \pi&#39;}{\Delta t}\\
    &amp; \qquad + \frac{1}{J} \left\{\frac{\partial J P^\# \mathcal{C}^{\rho u, \#, n + 1}}{\partial \widehat{x}} + \frac{\partial J P^\# \mathcal{C}^{\rho v, \#, n + 1}}{\partial \widehat{y}} \vphantom{\left[\left(\frac{\left(P /  \rho\right)^\#}{\overline{\theta}}\right)^{- 1}\right]}\right.\\
    &amp; \qquad \qquad \quad + \frac{\partial}{\partial \widehat{z}} \left[\left(1 + \beta_\mathrm{R}^{n + 1} \frac{\Delta t}{2} + \frac{\left(P /  \rho\right)^\#}{\overline{\theta}} \frac{\left(N \Delta t\right)^2}{4}\right)^{- 1}\right.\\
    &amp; \qquad \qquad \qquad \qquad \times \left(\frac{\Delta t}{2} J P^\# c_p \left(\frac{P}{\rho}\right)^\# \mathcal{D}^{\rho \widehat{w}} + J P^\# \frac{\left(P /  \rho\right)^\#}{\overline{\theta}} \frac{\left(N \Delta t\right)^2}{4}\right.\\
    &amp; \qquad \qquad \qquad \qquad \qquad \times \left.\left.\left.\left(G^{13} \mathcal{C}^{\rho u, \#, n + 1} + G^{23} \mathcal{C}^{\rho v, \#, n + 1}\right)\vphantom{\left(\frac{P^2}{\rho}\right)^\#}\right) \vphantom{\left(\frac{\left(P /  \rho\right)^\#}{\overline{\theta}}\right)^{- 1}}\right]\right\}
\end{align*}\]</p></li><li><p>Corrector step:</p><p class="math-container">\[\begin{align*}
    U^{n + 1 / 2} &amp; = \left(U^{n + 1 / 2} - J P^\# \mathcal{C}^{\rho u, \#, n + 1}\right),\\
    V^{n + 1 / 2} &amp; = \left(V^{n + 1 / 2} - J P^\# \mathcal{C}^{\rho v, \#, n + 1}\right),\\
    \widehat{W}^{n + 1 / 2} &amp; = \left\{\widehat{W}^{n + 1 / 2} - \left[1 + \beta_\mathrm{R}^{n + 1} \frac{\Delta t}{2} + \frac{\left(P /  \rho\right)^\#}{\overline{\theta}} \frac{\left(N \Delta t\right)^2}{4}\right]^{- 1}\right.\\
    &amp; \qquad \qquad \qquad \times \left[\frac{\Delta t}{2} J P^\# c_p \left(\frac{P}{\rho}\right)^\# \mathcal{D}^{\rho \widehat{w}} + J P^\# \frac{\left(P /  \rho\right)^\#}{\overline{\theta}} \frac{\left(N \Delta t\right)^2}{4}\right.\\
    &amp; \qquad \qquad \qquad \qquad \times \left.\left.\left(G^{1 3} \mathcal{C}^{\rho u, \#, n + 1} + G^{23} \mathcal{C}^{\rho v, \#, n + 1}\right) \vphantom{\left(\frac{P^2}{\rho}\right)^\#}\right] \vphantom{\left[\frac{\left(P /  \rho\right)^\#}{\overline{\theta}}\right]^{- 1}}\right\},\\
    \rho&#39;^{n + 1 / 2} &amp; \rightarrow \rho&#39;^{n + 1 / 2} + \frac{\rho^\#}{g} \left[1 + \beta_\mathrm{R}^{n + 1} \frac{\Delta t}{2} + \frac{\left(P /  \rho\right)^\#}{\overline{\theta}} \frac{\left(N \Delta t\right)^2}{4}\right]^{- 1}\\
    &amp; \quad \times \left[- \frac{\left(P /  \rho\right)^\#}{\overline{\theta}} \frac{\left(N \Delta t\right)^2}{4} J c_p \left(\frac{P}{\rho}\right)^\# \mathcal{D}^{\rho \widehat{w}}\right.\\
    &amp; \qquad \quad + \left.\frac{\left(P /  \rho\right)^\#}{\overline{\theta}} N^2 \frac{\Delta t}{2} J \left(1 + \beta_\mathrm{R}^{n + 1} \frac{\Delta t}{2}\right)  \left(G^{1 3} \mathcal{C}^{\rho u, \#, n + 1} + G^{2 3} \mathcal{C}^{\rho v, \#, n + 1}\right)\right],\\
    \pi&#39;^{n + 1 / 2} &amp; = \pi&#39;^n + \Delta \pi&#39;
\end{align*}\]</p></li></ol><p>The horizontal-wind correction terms are given by</p><p class="math-container">\[\begin{align*}
    \mathcal{C}^{\rho u, \#, n + 1} &amp; = \left(1 + \beta_\mathrm{R}^{n + 1} \frac{\Delta t}{2}\right)^{- 1} \frac{\Delta t}{2} c_p \left(\frac{P}{\rho}\right)^\# \mathcal{D}^{\rho u},\\
    \mathcal{C}^{\rho v, \#, n + 1} &amp; = \left(1 + \beta_\mathrm{R}^{n + 1} \frac{\Delta t}{2}\right)^{- 1} \frac{\Delta t}{2} c_p \left(\frac{P}{\rho}\right)^\# \mathcal{D}^{\rho v}.
\end{align*}\]</p></li><li><p>The right-hand sides (without the Rayleigh-damping terms) are integrated over <span>$\Delta t / 2$</span> with an explicit Euler step. In contrast to the pseudo-incompressible mode, the Exner-pressure fluctuations <span>$\pi&#39;^n$</span> are used to compute the pressure gradient. They are themselves also updated with the left-hand side of the prognostic equation for <span>$P$</span>. Thus, one has</p><p class="math-container">\[\begin{align*}
    U^* &amp; = \left\{U^n + \frac{\Delta t}{2} J P^n \left[- c_p \left(\frac{P}{\rho}\right)^n \mathcal{P}^{\rho u, n} + \frac{F^{\rho u, n + 1}}{\rho^n}\right]\right\},\\
    V^* &amp; = \left\{V^n + \frac{\Delta t}{2} J P^n \left[- c_p \left(\frac{P}{\rho}\right)^n \mathcal{P}^{\rho v, n} + \frac{F^{\rho v, n + 1}}{\rho^n}\right]\right\},\\
    \widehat{W}^* &amp; = \left\{\widehat{W}^n + \frac{\Delta t}{2} J P^n \left[- c_p \left(\frac{P}{\rho}\right)^n \mathcal{P}^{\rho \widehat{w}, n} + \frac{b&#39;^n}{J} + \frac{F^{\rho \widehat{w}, n + 1}}{\rho^n}\right]\right\},\\
    \rho&#39;^* &amp; = - \frac{\rho^n}{g} \left[b&#39;^n - \frac{\Delta t}{2} N^2 \frac{\left(P / \rho\right)^n}{\overline{\theta}} \frac{W^n}{J P^n}\right],\\
    \pi&#39;^* &amp; = \pi&#39;^n - \frac{\Delta t}{2} \left(\frac{\partial \pi&#39;}{\partial P}\right)^n \left\{\frac{1}{J} \left[\frac{\partial U^n}{\partial \widehat{x}} + \frac{\partial V^n}{\partial \widehat{y}} + \frac{\partial \widehat{W}^n}{\partial \widehat{z}}\right] - F^{P, n + 1}\right\}.
\end{align*}\]</p></li><li><p>The left-hand sides are integrated over <span>$\Delta t$</span> with the low-storage RK3 scheme. Fractional implicit Euler steps are once again used to integrate the Rayleigh-damping terms of the LHS sponge. This step is equivalent to the first one, except for the differences indicated in the compact description above.</p></li><li><p>The right-hand sides are integrated over over <span>$\Delta t / 2$</span> with an implicit Euler step, followed by the Poisson equation being solved and a correction step being performed. The Rayleigh-damping terms are doubled, since they were left out in the explicit Euler step. This step is equivalent to the second one, except for the differences indicated in the compact description above.</p></li></ol><h3 id="Tracer-transport"><a class="docs-heading-anchor" href="#Tracer-transport">Tracer transport</a><a id="Tracer-transport-1"></a><a class="docs-heading-anchor-permalink" href="#Tracer-transport" title="Permalink"></a></h3><p>Since its equation does not have a right-hand side, the tracer is only updated in the second and fifth step of the time scheme, analogous to the update of the mass-weighted potential temperature in compressible mode. At each RK-stage of the second step, one has</p><p class="math-container">\[\begin{align*}
    q^{\rho \chi, m + 1} &amp; = - \frac{\Delta t}{2} \left\{\frac{1}{J} \left[\frac{\partial J \left(\rho \chi\right)^m u^n}{\partial \widehat{x}} + \frac{\partial J \left(\rho \chi\right)^m v^n}{\partial \widehat{y}} + \frac{\partial J \left(\rho \chi\right)^m \widehat{w}^n}{\partial \widehat{z}}\right] - F^{\rho \chi, n + 1}\right\} + \left(\alpha_\mathrm{RK} q^{\rho \chi}\right)^m,\\
    \left(\rho \chi\right)^{m + 1} &amp; = \left(\rho \chi\right)^m + \beta_\mathrm{RK}^m q^{\rho \chi, m + 1},\\
    \left(\rho \chi\right)^{m + 1} &amp; \rightarrow \left(1 + \alpha_\mathrm{R} f_\mathrm{RK}^m \frac{\Delta t}{2}\right)^{- 1} \left[\left(\rho \chi\right)^{m + 1} + \alpha_\mathrm{R} f_\mathrm{RK}^m \frac{\Delta t}{2} \left(\rho \chi\right)^{\left(0\right)}\right].
\end{align*}\]</p><h3 id="MSGWaM"><a class="docs-heading-anchor" href="#MSGWaM">MSGWaM</a><a id="MSGWaM-1"></a><a class="docs-heading-anchor-permalink" href="#MSGWaM" title="Permalink"></a></h3><p>At the beginning of each time step, the saturation scheme is applied via integration of the respective term in the phase-space wave-action density equation with an explicit Euler step. i.e.</p><p class="math-container">\[\mathcal{N}^{n + 1} = \mathcal{N}^n + \Delta t \mathcal{S}_s^n.\]</p><p>The ray equations are then integrated with the low-storage RK3 scheme, following</p><p class="math-container">\[\begin{align*}
    q^{x, m + 1} &amp; = \Delta t \frac{\partial \Omega^{m, n}}{\partial k} + \alpha_\mathrm{RK}^m q^{x, m}, &amp; x^{m + 1} &amp; = x^m + \beta_\mathrm{RK}^m q^{x, m + 1},\\
    q^{y, m + 1} &amp; = \Delta t \frac{\partial \Omega^{m, n}}{\partial l}  + \alpha_\mathrm{RK}^m q^{y, m}, &amp; y^{m + 1} &amp; = y^m + \beta_\mathrm{RK}^m q^{y, m + 1},\\
    q^{z, m + 1} &amp; = \Delta t \frac{\partial \Omega^{m, n}}{\partial m} + \alpha_\mathrm{RK}^m q^{z, m}, &amp; z^{m + 1} &amp; = z^m + \beta_\mathrm{RK}^m q^{z, m + 1},\\
    q^{k, m + 1} &amp; = \Delta t \left(\frac{\partial \Omega^{m, n}}{\partial \widehat{x}} + G^{13} \frac{\partial \Omega^{m, n}}{\partial \widehat{z}}\right) + \alpha_\mathrm{RK}^m q^{k, m}, &amp; k^{m + 1} &amp; = k^m + \beta_\mathrm{RK}^m q^{k, m + 1},\\
    q^{l, m + 1} &amp; = \Delta t \left(\frac{\partial \Omega^{m, n}}{\partial \widehat{y}} + G^{23} \frac{\partial \Omega^{m, n}}{\partial \widehat{z}}\right) + \alpha_\mathrm{RK}^m q^{l, m}, &amp; l^{m + 1} &amp; = l^m + \beta_\mathrm{RK}^m q^{l, m + 1},\\
    q^{m, m + 1} &amp; = \frac{\Delta t}{J} \frac{\partial \Omega^{m, n}}{\partial \widehat{z}} + \alpha_\mathrm{RK}^m q^{m, m}, &amp; m^{m + 1} &amp; = m^m + \beta_\mathrm{RK}^m q^{m, m + 1},
\end{align*}\]</p><p>where <span>$\Omega^{m, n} = \Omega \left(\boldsymbol{x}^m, \boldsymbol{k}^m, \widehat{\boldsymbol{u}}^n\right)$</span>. At the end of every RK3 stage, the Rayleigh damping of the LHS sponge is applied to the phase-space wave-action density with a fractional implicit Euler step, i.e.</p><p class="math-container">\[\mathcal{N}^{n + 1} \rightarrow \left(1 + 2 \alpha_\mathrm{R}^{n + 1} f_\mathrm{RK}^m \Delta t\right)^{- 1} \mathcal{N}^{n + 1}.\]</p><p>Note that the intrinsic frequency does not need to be updated since it is completely determined the other variables. Finally, the mean-flow tendencies for the current time step are calculated from the updated wave-property fields (<a href="https://doi.org/10.1175/JAS-D-24-0158.1">Jochum et al., 2025</a>).</p><h2 id="Spatial-discretization"><a class="docs-heading-anchor" href="#Spatial-discretization">Spatial discretization</a><a id="Spatial-discretization-1"></a><a class="docs-heading-anchor-permalink" href="#Spatial-discretization" title="Permalink"></a></h2><p>PinCFlow.jl is a finite-volume code that operates on a three-dimensional staggered C-grid (<a href="https://doi.org/10.1016/b978-0-12-460817-7.50009-4">Arakawa &amp; Lamb, 1977</a>), with scalar fields defined at the cell centers and velocity components defined at the respective interfaces (<a href="https://doi.org/10.1175/mwr-d-12-00026.1">Rieper et al., 2013</a>). Advective-flux divergences are discretized with a monotone upwind scheme for conservation laws (<a href="https://doi.org/10.2514/6.2003-3559">van Leer, 2003</a>) and a monotonized-centered variant limiter (e.g. <a href="https://doi.org/10.1002/fld.2357">Kemm, 2010</a>). More specifically, the implementation is such that <span>$P \widehat{\boldsymbol{u}}$</span> is the carrier flux (based on <a href="https://doi.org/10.1007/s00162-009-0104-y">Klein, 2009</a>; <a href="https://doi.org/10.1175/mwr-d-13-00384.1">Benacchio et al., 2014</a>; <a href="https://doi.org/10.1016/j.jcp.2014.01.031">Smolarkiewicz et al., 2014</a> and <a href="https://doi.org/10.1175/mwr-d-19-0073.1">Benacchio &amp; Klein, 2019</a>). All other terms are discretized with centered differences (e.g. <a href="https://doi.org/10.1007/978-1-4419-6412-0">Durran, 2010</a>). A Cartesian version of this is described in <a href="https://doi.org/10.1175/mwr-d-12-00026.1">Rieper et al. (2013)</a> and <a href="https://doi.org/10.1175/MWR-D-21-0126.1">Schmid et al. (2021)</a>.</p><p>The spatial discretization of MSGWaM is based on the definition of ray volumes, six-dimensional cubes in phase space. The ray equations are integrated at the center points and surface midpoints, using trilinear interpolation to get mean-flow information at the locations of interest. To prevent uninhibited growing, ray volumes are split when their extent in any dimension of physical space exceeds the corresponding grid spacing. This is counteracted by merging in spectral space to keep the number of ray volumes below a user-defined threshold. In the computation of the mean-flow impact, the contribution of each ray volume is weighted by the fraction of the local grid cell covered by it. A more detailed description of the algorithm can be found in <a href="https://doi.org/10.1002/qj.2381">Muraschko et al. (2014)</a>, <a href="https://doi.org/10.1175/JAS-D-16-0069.1">Boeloeni et al. (2016)</a>, <a href="https://doi.org/10.1175/JAS-D-17-0289.1">Wilhelm et al. (2018)</a>, <a href="https://doi.org/10.1175/JAS-D-18-0337.1">Wei et al. (2019)</a> and <a href="https://doi.org/10.1175/JAS-D-24-0158.1">Jochum et al. (2025)</a>.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../physics/">« Physics</a><a class="docs-footer-nextpage" href="../../reference/pincflow/">PinCFlow »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.15.0 on <span class="colophon-date" title="Tuesday 28 October 2025 10:27">Tuesday 28 October 2025</span>. Using Julia version 1.10.10.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
