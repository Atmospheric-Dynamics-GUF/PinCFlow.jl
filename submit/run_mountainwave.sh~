#!/bin/bash
#SBATCH --partition=general1
#SBATCH --ntasks=128
#SBATCH --cpus-per-task=1
#SBATCH --mem-per-cpu=2600
#SBATCH --mail-type=FAIL
#SBATCH --time=02:30:00
#SBATCH --extra-node-info=2:20:1
#SBATCH --job-name=mw



set -x

#echo "------------------------------------------------------------"
#echo LOADL_STEP_ID=$LOADL_STEP_ID
#echo "------------------------------------------------------------"

#set -x

# no. of processors ntasks must be nprocx * nprocy
ntasks=128
nprocx=128
nprocy=1

# OpenMP settings
export OMP_NUM_THREADS=1

# gprof for MPI
export GMON_OUT_PREFIX=gmon.out-

# env variable export
export LD_LIBRARY_PATH=LD_LIBRARY_PATH:/home/atmodynamics/schmid/spack/opt/spack/linux-scientific7-x86_64/intel-18.0.3/hypre-2.15.1-j7lo2mzfhd7bnrcivaf6bsaqjwimsp3m/lib/


d_home=/home/atmodynamics/schmid/git_PF_2020/pinc_f2Omegasiny_BK19cases
d_scratch=/scratch/atmodynamics/schmid

d_nam=${d_home}/bin_mountainwave
fp_exe=${d_home}/bin_mountainwave/pinc
d_work=${d_scratch}/mountainwave


mkdir ${d_work}

#- go to work

cd ${d_work}

# copy namelist
sed -e "s/{nprocx}/${nprocx}/" \
    -e "s/{nprocy}/${nprocy}/" \
        ${d_nam}/input.f90 > input.f90

#- run the raytracer
mpirun -np ${ntasks} ${fp_exe} 1>run.log 2>&1

exit 0
